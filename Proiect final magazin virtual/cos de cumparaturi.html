<html>
<head>
		<link rel="stylesheet" type="text/css" href="magazin.css">  
    <script>
		var produse = {};
        function ajax(method,url,body,callback, rejectCallback){
			var xhttp = new XMLHttpRequest();
			xhttp.onreadystatechange = function() {
				if (this.readyState === 4){
					if(this.status === 200) {
						if(typeof callback==="function"){
							callback(JSON.parse(this.responseText));
						}
					} else {
						if(typeof rejectCallback==="function"){
							rejectCallback(new Error("serverul a dat eroare"));
						}
					}
				}
			};
			xhttp.open(method, url, true);
			if(body !== undefined){
				xhttp.send(body);
			} else{
				xhttp.send();
			}
		}


		function loading(){
			let loader = document.querySelector("#loader");
			if(loader.style.display === "none"){
				loader.style.display = "block";
			} else {
				loader.style.display = "none";
			}
		}
		
        var cos={};

        function localStorageToFirebase(){
			if(localStorage.hasOwnProperty("cos")){
				cosLocalStorage  = localStorage.getItem("cos");
				ajax("PUT",`https://awesome-c1c34.firebaseio.com/cos.json`,cosLocalStorage);
			} else{
				ajax("DELETE", `https://awesome-c1c34.firebaseio.com/cos.json`);
			}
        }
		function updateQty(op, id){
			let currValue = cos[id].cantitate;
			if(op === '-'){
				currValue--;
			}else{
				currValue++;
			}
			cos[id].cantitate = currValue;
			if(cos[id].cantitate <= 0){
				delete cos[id];
			} else if(cos[id].cantitate > produse[id].stoc){
				cos[id].cantitate = produse[id].stoc;
			}
			let cosJSON =  JSON.stringify(cos);
			if(cosJSON =="[null]"){
				localStorage.removeItem("cos");
			} else{
				localStorage.setItem("cos", JSON.stringify(cos));
			}
			localStorageToFirebase();
			draw();
		}
		function del(id){
			delete cos[id];
			let cosJSON =  JSON.stringify(cos);
			if(cosJSON =="[null]"){
				localStorage.removeItem("cos");
			} else{
				localStorage.setItem("cos", JSON.stringify(cos));
			}
			localStorageToFirebase();
			draw();
		}
		function getProduse(){
			fetch("https://awesome-c1c34.firebaseio.com/produse.json")
			.then(response => response.json()) //il interpreteaza si il transforma in obiectca json
			.then(p => { 
				produse = p; 
			});
		}


        function draw(){
			var str = "";
			for(let i in cos){
				if(cos[i]===null){continue;}
				
				str+=`

                <tr style='text-align:center'>
					
					<td class="imagine"><div style='width:100%; height:70px; background-image: url(${cos[i].imagine}); background-repeat: no-repeat; background-size: contain; background-position: center'></div></td>
                    <td class="nume">${cos[i].nume}</td>
                    <td class="pret">${cos[i].pret} RON</td>
                    <td class="cantitate"><span class='removeqty' onclick="updateQty('-',${i});" style='padding:2px; color:blue; cursor:pointer; '>-</span><input style="width:70%" type='number' value='${cos[i].cantitate}' /><span class='addqty' style='padding:2px; color:blue; cursor:pointer' onclick="updateQty('+',${i});">+</span></td>
                    <td class="Valoare">${parseInt(cos[i].cantitate)*parseInt(cos[i].pret)} RON</td>
		
					<td style="white-space:nowrap;">
						<div onclick="del('${i}');"><a href="#">Remove</a></div>
					</td>
				</tr>
				`
			}
			document.querySelector(".listaProduseincos").innerHTML=str;
			
		}
		function finishOrder(){
			for (var idProdus in cos){
 				if (cos.hasOwnProperty(idProdus)) {
					produse[idProdus].stoc -= cos[idProdus].cantitate;
    			}
			}
			cos = {};
			localStorage.removeItem("cos");
			localStorageToFirebase();
			let produseJson = JSON.stringify(produse); //transforma obiectul in string de tip json
			ajax("PUT", "https://awesome-c1c34.firebaseio.com/produse.json", produseJson);
			draw();
		}
		function loadMethod(){
			cos = JSON.parse(localStorage.getItem("cos"));
			localStorageToFirebase(); 
			getProduse();
			draw();
		}
    </script>
</head>
<body onload= "loadMethod();" >
	<h2 onclick="location.href='magazin.html'">Magazinul meu</h2>
	
	<div id="loader" style="display: none; ">
		<svg class="lds-default" width="100px" height="100px" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewBox="0 0 100 100" preserveAspectRatio="xMidYMid"><circle cx="75" cy="50" fill="undefined" r="3">
			<animate attributeName="r" values="3;3;5;3;3" times="0;0.1;0.2;0.3;1" dur="1s" repeatCount="indefinite" begin="-0.917s"></animate>
			<animate attributeName="fill" values="#e0b83e;#e0b83e;#bd4030;#e0b83e;#e0b83e" repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.917s"></animate>
		</circle><circle cx="71.651" cy="62.5" fill="undefined" r="3">
			<animate attributeName="r" values="3;3;5;3;3" times="0;0.1;0.2;0.3;1" dur="1s" repeatCount="indefinite" begin="-0.833s"></animate>
			<animate attributeName="fill" values="#e0b83e;#e0b83e;#bd4030;#e0b83e;#e0b83e" repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.833s"></animate>
		</circle><circle cx="62.5" cy="71.651" fill="undefined" r="3">
			<animate attributeName="r" values="3;3;5;3;3" times="0;0.1;0.2;0.3;1" dur="1s" repeatCount="indefinite" begin="-0.75s"></animate>
			<animate attributeName="fill" values="#e0b83e;#e0b83e;#bd4030;#e0b83e;#e0b83e" repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.75s"></animate>
		</circle><circle cx="50" cy="75" fill="undefined" r="3">
			<animate attributeName="r" values="3;3;5;3;3" times="0;0.1;0.2;0.3;1" dur="1s" repeatCount="indefinite" begin="-0.667s"></animate>
			<animate attributeName="fill" values="#e0b83e;#e0b83e;#bd4030;#e0b83e;#e0b83e" repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.667s"></animate>
		</circle><circle cx="37.5" cy="71.651" fill="undefined" r="3">
			<animate attributeName="r" values="3;3;5;3;3" times="0;0.1;0.2;0.3;1" dur="1s" repeatCount="indefinite" begin="-0.583s"></animate>
			<animate attributeName="fill" values="#e0b83e;#e0b83e;#bd4030;#e0b83e;#e0b83e" repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.583s"></animate>
		</circle><circle cx="28.349" cy="62.5" fill="undefined" r="3.14295">
			<animate attributeName="r" values="3;3;5;3;3" times="0;0.1;0.2;0.3;1" dur="1s" repeatCount="indefinite" begin="-0.5s"></animate>
			<animate attributeName="fill" values="#e0b83e;#e0b83e;#bd4030;#e0b83e;#e0b83e" repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.5s"></animate>
		</circle><circle cx="25" cy="50" fill="undefined" r="3.80695">
			<animate attributeName="r" values="3;3;5;3;3" times="0;0.1;0.2;0.3;1" dur="1s" repeatCount="indefinite" begin="-0.417s"></animate>
			<animate attributeName="fill" values="#e0b83e;#e0b83e;#bd4030;#e0b83e;#e0b83e" repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.417s"></animate>
		</circle><circle cx="28.349" cy="37.5" fill="undefined" r="4.47895">
			<animate attributeName="r" values="3;3;5;3;3" times="0;0.1;0.2;0.3;1" dur="1s" repeatCount="indefinite" begin="-0.333s"></animate>
			<animate attributeName="fill" values="#e0b83e;#e0b83e;#bd4030;#e0b83e;#e0b83e" repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.333s"></animate>
		</circle><circle cx="37.5" cy="28.349" fill="undefined" r="4.85705">
			<animate attributeName="r" values="3;3;5;3;3" times="0;0.1;0.2;0.3;1" dur="1s" repeatCount="indefinite" begin="-0.25s"></animate>
			<animate attributeName="fill" values="#e0b83e;#e0b83e;#bd4030;#e0b83e;#e0b83e" repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.25s"></animate>
		</circle><circle cx="50" cy="25" fill="undefined" r="4.19305">
			<animate attributeName="r" values="3;3;5;3;3" times="0;0.1;0.2;0.3;1" dur="1s" repeatCount="indefinite" begin="-0.167s"></animate>
			<animate attributeName="fill" values="#e0b83e;#e0b83e;#bd4030;#e0b83e;#e0b83e" repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.167s"></animate>
		</circle><circle cx="62.5" cy="28.349" fill="undefined" r="3.52105">
			<animate attributeName="r" values="3;3;5;3;3" times="0;0.1;0.2;0.3;1" dur="1s" repeatCount="indefinite" begin="-0.083s"></animate>
			<animate attributeName="fill" values="#e0b83e;#e0b83e;#bd4030;#e0b83e;#e0b83e" repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="-0.083s"></animate>
		</circle><circle cx="71.651" cy="37.5" fill="undefined" r="3">
			<animate attributeName="r" values="3;3;5;3;3" times="0;0.1;0.2;0.3;1" dur="1s" repeatCount="indefinite" begin="0s"></animate>
			<animate attributeName="fill" values="#e0b83e;#e0b83e;#bd4030;#e0b83e;#e0b83e" repeatCount="indefinite" times="0;0.1;0.2;0.3;1" dur="1s" begin="0s"></animate>
		</circle></svg>
		</div>
		
		
		<div class='response'></div>
    <table>
        <th style="width:15%;">Imagine</th>
        <th style="width:15%;">Produs</th>
        <th style="width:15%;">Pret unitar</th>
        <th style="width:15%;">Cantitate</th>
		<th style="width:15%;">Valoare</th>
		<th style="width:15%">Actiuni</th>
        <tbody class='listaProduseincos'>

		</tbody>
    </table>

	<button style="float:right; margin-right: 5%; background-color: orangered; border-radius: 5px;" onclick="finishOrder()">Finalizeaza comanda</button>
	<button style="float:right; margin-right: 5%; background-color: darkgreen; border-radius: 5px;" onclick="location.href='magazin.html'" >Continua cumparaturile</button>



</body>
</html>